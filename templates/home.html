{% extends "base.html" %}
{% block content %}

<h1>Explore Bridges in India</h1>

<!-- ðŸ” Search Bar -->
<form method="get" action="{{ url_for('search') }}" class="filters" style="margin-bottom: 20px;">
  <label>Search Bridges:</label>
  <input type="text" name="q" placeholder="Name or river">
  <button type="submit">Search</button>
</form>

<!-- ðŸŒ Filters by Location -->
<div class="filters">
  <h2>Search by Location</h2>

  <div class="filter-row">
    <label>Country:</label>
    <select id="country-select">
      <option value="">-- Select Country --</option>
      {% for c in countries %}
      <option value="{{ c.id }}">{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="filter-row">
    <label>State:</label>
    <select id="state-select" disabled>
      <option value="">-- Select State --</option>
    </select>
  </div>

  <div class="filter-row">
    <label>District:</label>
    <select id="district-select" disabled>
      <option value="">-- Select District --</option>
    </select>
  </div>

  <div class="filter-row">
    <label>Bridge:</label>
    <select id="bridge-select" disabled>
      <option value="">-- Select Bridge --</option>
    </select>
  </div>

  <button id="view-btn" disabled>View Bridge Info</button>
</div>

<!-- ðŸ—ï¸ Famous Bridges Section -->
<h2>Famous Bridges</h2>
<div class="bridge-grid">
  {% for b in famous_bridges %}
  <div class="bridge-card">
    {% if b.image_url %}
      <img src="{{ b.image_url }}" alt="{{ b.name }}" style="width:100%; height:auto; border-radius:8px;">
    {% else %}
      <img src="https://via.placeholder.com/400x200?text=No+Image" alt="No image available" style="width:100%; height:auto; border-radius:8px;">
    {% endif %}
    <h3>{{ b.name }}</h3>
    <p>{{ b.district.name }}, {{ b.district.state.name }}</p>
  </div>
  {% endfor %}
</div>

<!-- âš™ï¸ Dynamic Dropdown Script -->
<script>
  const countrySelect = document.getElementById("country-select");
  const stateSelect = document.getElementById("state-select");
  const districtSelect = document.getElementById("district-select");
  const bridgeSelect = document.getElementById("bridge-select");
  const viewBtn = document.getElementById("view-btn");

  // Load states when country changes
  countrySelect.addEventListener("change", async () => {
    const countryId = countrySelect.value;
    stateSelect.innerHTML = '<option value="">-- Select State --</option>';
    districtSelect.innerHTML = '<option value="">-- Select District --</option>';
    bridgeSelect.innerHTML = '<option value="">-- Select Bridge --</option>';
    stateSelect.disabled = true;
    districtSelect.disabled = true;
    bridgeSelect.disabled = true;
    viewBtn.disabled = true;

    if (!countryId) return;

    const res = await fetch(`/api/states?country_id=${countryId}`);
    const states = await res.json();
    states.forEach((s) => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.name;
      stateSelect.appendChild(opt);
    });
    stateSelect.disabled = false;
  });

  // Load districts when state changes
  stateSelect.addEventListener("change", async () => {
    const stateId = stateSelect.value;
    districtSelect.innerHTML = '<option value="">-- Select District --</option>';
    bridgeSelect.innerHTML = '<option value="">-- Select Bridge --</option>';
    districtSelect.disabled = true;
    bridgeSelect.disabled = true;
    viewBtn.disabled = true;

    if (!stateId) return;

    const res = await fetch(`/api/districts?state_id=${stateId}`);
    const districts = await res.json();
    districts.forEach((d) => {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name;
      districtSelect.appendChild(opt);
    });
    districtSelect.disabled = false;
  });

  // Load bridges when district changes
  districtSelect.addEventListener("change", async () => {
    const districtId = districtSelect.value;
    bridgeSelect.innerHTML = '<option value="">-- Select Bridge --</option>';
    bridgeSelect.disabled = true;
    viewBtn.disabled = true;

    if (!districtId) return;

    const res = await fetch(`/api/bridges?district_id=${districtId}`);
    const bridges = await res.json();
    bridges.forEach((b) => {
      const opt = document.createElement("option");
      opt.value = b.id;
      opt.textContent = b.name;
      bridgeSelect.appendChild(opt);
    });
    bridgeSelect.disabled = false;
  });

  // Enable View button
  bridgeSelect.addEventListener("change", () => {
    viewBtn.disabled = !bridgeSelect.value;
  });

  // View bridge details (redirect)
  viewBtn.addEventListener("click", () => {
    const id = bridgeSelect.value;
    if (id) window.location.href = `/api/bridges/${id}`;
  });
</script>

{% endblock %}
